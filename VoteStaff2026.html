<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back to School - International Best Dressed</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    
    <style>
        :root { --primary: #4e73df; --secondary: #1cc88a; --danger: #e74a3b; --dark: #5a5c69; }
        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; }
        body { background-color: #f0f2f5; margin: 0; padding: 0; color: var(--dark); }
        
        .nav-tabs { display: flex; background: white; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); justify-content: center; }
        .tab-item { padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; font-weight: 600; }
        .tab-item.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        .content { display: none; animation: fadeIn 0.5s; }
        .content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #reg-popup { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .popup-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .card img { width: 100%; height: 320px; object-fit: cover; background: #eee; }
        .card-body { padding: 15px; }

        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; outline: none; }
        .btn { border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; }
        .btn-vote { background: var(--primary); color: white; }
        .btn-voted { background: #ccc; color: #666; cursor: not-allowed; }

        .admin-item { display: flex; align-items: center; gap: 15px; background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ddd; }
        .admin-item img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
        .upload-btn { background: #f3f4f6; border: 2px dashed #ccc; padding: 10px; cursor: pointer; border-radius: 8px; display: block; margin-top: 5px; font-size: 0.8rem; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div id="reg-popup">
        <div class="popup-box">
            <h2 style="margin-top:0">Back to School ‡πÇ‡∏´‡∏ß‡∏ï üéí</h2>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå / 1 ‡πÇ‡∏´‡∏ß‡∏ï)</p>
            <input type="tel" id="user-phone" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å" maxlength="10">
            <button class="btn btn-vote" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏ß‡∏ï</button>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="tab-item active" onclick="switchTab(0)">üó≥Ô∏è ‡πÇ‡∏´‡∏ß‡∏ï</div>
        <div class="tab-item" onclick="switchTab(1)">üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
        <div class="tab-item" onclick="switchTab(2)">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ</div>
        <div class="tab-item" onclick="switchTab(3)">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
    </div>

    <div class="container">
        <div id="tab-vote" class="content active">
            <div style="display:flex; justify-content: space-between; margin-bottom: 20px;">
                <span>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <b id="display-phone">-</b></span>
                <button onclick="logout()" style="color:var(--danger); border:none; background:none; cursor:pointer">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            <div class="grid" id="vote-grid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>

        <div id="tab-result" class="content">
            <h2>üìä ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏´‡∏ß‡∏ï (Realtime)</h2>
            <div id="result-container"></div>
        </div>

        <div id="tab-admin" class="content">
            <div id="admin-lock" class="popup-box" style="margin: 50px auto; border: 1px solid #ddd;">
                <h3>üîê Admin Access</h3>
                <input type="password" id="admin-pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•">
                <button class="btn btn-vote" style="background:var(--dark)" onclick="unlockAdmin()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
            <div id="admin-content" style="display:none">
                <h2>‚öôÔ∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà</h2>
                <div id="admin-list"></div>
                <button class="btn" style="background:var(--danger); color:white; margin-top:20px;" onclick="resetSystem()">üß® ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>

        <div id="tab-logs" class="content">
            <h2>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</h2>
            <div id="logs-locked" style="text-align:center; padding:50px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin ‡∏Å‡πà‡∏≠‡∏ô</div>
            <table id="logs-table" style="display:none">
                <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏•‡∏Ç</th></tr></thead>
                <tbody id="voter-table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBg4LzxXAJ2fzXvwzGEXNMVja6Ycrhb6so",
            authDomain: "backtoschoolvote.firebaseapp.com",
            projectId: "backtoschoolvote",
            storageBucket: "backtoschoolvote.firebasestorage.app",
            messagingSenderId: "789699804404",
            appId: "1:789699804404:web:f1c417afb881c3cd0c72a1",
            databaseURL: "https://backtoschoolvote-default-rtdb.asia-southeast1.firebasedatabase.app" 
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentPhone = localStorage.getItem('currentPhone') || "";
        const ADMIN_CODE = "534087";
        let hasVoted = false;

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î
        db.ref('contestants').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) { initSystem(); } else {
                renderVoting(data);
                renderResults(data);
                renderAdmin(data);
            }
        });

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ hasVoted
        db.ref('voterLogs').on('value', (snapshot) => {
            const logs = snapshot.val() || {};
            hasVoted = Object.values(logs).some(l => l.phone === currentPhone);
            renderLogs(logs);
            // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏ß‡∏ï‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
            db.ref('contestants').once('value', (s) => renderVoting(s.val()));
        });

        function initSystem() {
            const contestants = {};
            for(let i=1; i<=12; i++) {
                contestants[i] = { id: i, votes: 0, img: "https://via.placeholder.com/400x500?text=No+Image" };
            }
            db.ref('contestants').set(contestants);
        }

        function login() {
            const phone = document.getElementById('user-phone').value.trim();
            if (phone.length !== 10) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ 10 ‡∏´‡∏•‡∏±‡∏Å");
            currentPhone = phone;
            localStorage.setItem('currentPhone', phone);
            document.getElementById('reg-popup').style.display = 'none';
            document.getElementById('display-phone').innerText = phone;
            location.reload(); 
        }

        function logout() { localStorage.removeItem('currentPhone'); location.reload(); }

        function renderVoting(data) {
            const grid = document.getElementById('vote-grid');
            if(!data) return;
            grid.innerHTML = Object.values(data).map(item => `
                <div class="card">
                    <img src="${item.img}">
                    <div class="card-body">
                        <h3>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${item.id}</h3>
                        <button class="btn ${hasVoted ? 'btn-voted' : 'btn-vote'}" 
                                onclick="handleVote(${item.id})" ${hasVoted ? 'disabled' : ''}>
                            ${hasVoted ? '‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß' : '‡πÇ‡∏´‡∏ß‡∏ï'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Å‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å Server ‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô
        async function handleVote(id) {
            if (!currentPhone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏ß‡∏ï");
            
            // ‡πÄ‡∏ä‡πá‡∏Å‡∏à‡∏≤‡∏Å Database ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            const snapshot = await db.ref('voterLogs').once('value');
            const logs = snapshot.val() || {};
            const alreadyVoted = Object.values(logs).some(l => l.phone === currentPhone);

            if (alreadyVoted) {
                alert("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
                hasVoted = true;
                return;
            }

            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${id}?`)) return;

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase
            db.ref(`contestants/${id}/votes`).transaction(c => (c || 0) + 1);
            db.ref('voterLogs').push({
                phone: currentPhone,
                votedFor: id,
                time: new Date().toLocaleString('th-TH')
            });
            alert("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡∏Ñ‡∏£‡∏±‡∏ö!");
        }

        function handleFileUpload(input, id) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => db.ref(`contestants/${id}/img`).set(e.target.result);
            reader.readAsDataURL(file);
        }

        function renderResults(data) {
            if(!data) return;
            const sorted = Object.values(data).sort((a,b) => b.votes - a.votes);
            document.getElementById('result-container').innerHTML = sorted.map((c, i) => `
                <div class="admin-item" style="border-left: 5px solid ${i==0?'gold':'#4e73df'}">
                    <img src="${c.img}">
                    <div style="flex-grow:1"><b>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${i+1}:</b> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${c.id}</div>
                    <div style="font-size:1.3rem; font-weight:bold; color:var(--primary)">${c.votes} ‡πÇ‡∏´‡∏ß‡∏ï</div>
                </div>
            `).join('');
        }

        function renderAdmin(data) {
            if(!data) return;
            document.getElementById('admin-list').innerHTML = Object.values(data).map(c => `
                <div class="admin-item">
                    <img src="${c.img}">
                    <div style="flex-grow:1">
                        <b>‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${c.id}</b>
                        <label class="upload-btn">
                            üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
                            <input type="file" accept="image/*" style="display:none" onchange="handleFileUpload(this, ${c.id})">
                        </label>
                    </div>
                </div>
            `).join('');
        }

        function renderLogs(logs) {
            const body = document.getElementById('voter-table-body');
            body.innerHTML = Object.values(logs).reverse().map(l => `
                <tr><td>${l.time}</td><td>${l.phone}</td><td>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${l.votedFor}</td></tr>
            `).join('');
        }

        function unlockAdmin() {
            if (document.getElementById('admin-pass').value === ADMIN_CODE) {
                document.getElementById('admin-lock').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                document.getElementById('logs-table').style.display = 'table';
                document.getElementById('logs-locked').style.display = 'none';
            } else { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
        }

        function switchTab(index) {
            document.querySelectorAll('.content').forEach((t, i) => t.classList.toggle('active', i === index));
            document.querySelectorAll('.tab-item').forEach((n, i) => n.classList.toggle('active', i === index));
        }

        function resetSystem() {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                db.ref('voterLogs').remove();
                db.ref('contestants').once('value', s => {
                    const data = s.val();
                    for(let k in data) data[k].votes = 0;
                    db.ref('contestants').set(data);
                });
                alert("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            }
        }

        window.onload = () => {
            if (currentPhone) {
                document.getElementById('reg-popup').style.display = 'none';
                document.getElementById('display-phone').innerText = currentPhone;
            }
        };
    </script>
</body>
</html>